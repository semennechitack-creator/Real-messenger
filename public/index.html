<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Messenger</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #007bff; --dark: #1e1e1e; --light: #f4f4f4; }
        body { font-family: sans-serif; background: #121212; color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        /* --- AUTH SCREENS --- */
        .auth-container { background: var(--dark); padding: 2rem; border-radius: 10px; text-align: center; width: 300px; display: none; }
        .auth-container.active { display: block; }
        input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
        button { padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .link { color: var(--primary); cursor: pointer; font-size: 0.9rem; margin-top: 10px; display: block; }

        /* --- CHAT SCREEN --- */
        .app-container { display: none; width: 900px; height: 90vh; background: var(--dark); border-radius: 10px; overflow: hidden; box-shadow: 0 0 20px black; position: relative;}
        .app-container.active { display: flex; }
        
        .sidebar { width: 250px; background: #252525; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar h3 { padding: 20px; margin: 0; border-bottom: 1px solid #333; }
        .user-list { padding: 10px; overflow-y: auto; flex: 1; }
        .user-item { padding: 10px; cursor: pointer; border-radius: 5px; display: flex; align-items: center; gap: 10px; transition: background 0.1s; }
        .user-item:not([data-active="true"]):not([style*="background"]):hover { background: #333; }
        .user-item[data-active="true"] { border: 2px solid var(--primary); background: #333; }

        .online-dot { width: 10px; height: 10px; background: lime; border-radius: 50%; }

        .chat-area { flex: 1; display: flex; flex-direction: column; background: #121212; }
        .chat-header { padding: 15px; background: #252525; border-bottom: 1px solid #333; font-weight: bold; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { padding: 10px 15px; border-radius: 10px; max-width: 70%; word-wrap: break-word; }
        .msg.sent { align-self: flex-end; background: var(--primary); }
        .msg.received { align-self: flex-start; background: #333; }
        .msg-meta { font-size: 0.7rem; opacity: 0.7; margin-top: 5px; text-align: right; }
        
        .input-area { padding: 20px; background: #252525; display: flex; gap: 10px; align-items: center; }
        .input-area button {width: 80px;}

        /* –°–¢–ò–õ–ò –î–õ–Ø –ú–£–õ–¨–¢–ò–ú–ï–î–ò–ê */
        .msg img, .msg video {
            max-width: 100%;
            max-height: 200px; 
            border-radius: 8px;
            display: block;
            margin: 5px 0;
        }
        .msg a {
            color: lightblue;
            text-decoration: none;
            display: block;
            word-break: break-all;
        }
        
        /* –°–¢–ò–õ–ò –î–õ–Ø –≠–ú–û–î–ó–ò (—Å—Ç–∏–∫–µ—Ä—ã) */
        .emoji-sticker {
            font-size: 1.8em; 
            display: inline-block;
        }

        /* --- –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø --- */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .voice-message button {
            background: #28a745;
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
        }
        .voice-message audio {
            width: 150px;
        }

        /* --- –ó–ê–ü–ò–°–¨ –ì–û–õ–û–°–ê UI --- */
        #voice-record-btn {
            width: 40px;
            height: 40px;
            background: #d9534f;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            flex-shrink: 0;
            transition: transform 0.1s;
        }
        #voice-record-btn:active {
            transform: scale(0.9);
        }
        .recording {
            animation: pulse 1s infinite alternate;
            background: red !important;
        }
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }


        /* --- CALL MODAL STYLES --- */
        #call-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 10; display: none; 
            flex-direction: column; align-items: center; justify-content: center;
        }
        #localVideo {
            width: 350px; height: 250px; background: #222; border-radius: 8px;
            transform: scaleX(-1);
        }
        #remoteVideo {
            width: 350px; height: 250px; background: #222; border-radius: 8px;
        }
        #call-controls button {
            width: 50px; height: 50px; border-radius: 50%; margin: 5px;
            font-size: 1.5rem;
        }
        #call-controls #hangup-btn {
            width: 70px; height: 50px; border-radius: 25px; 
            background: #d9534f; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="auth-container active">
        <h2>–í—Ö–æ–¥</h2>
        <input type="text" id="login-user" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <span class="link" onclick="showRegister()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
    </div>

    <div id="register-screen" class="auth-container">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input type="text" id="reg-user" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è">
        <input type="password" id="reg-pass" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <span class="link" onclick="showLogin()">–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í—Ö–æ–¥</span>
    </div>

    <div id="app-screen" class="app-container">
        
        <div id="call-modal">
            <h2 id="call-status">–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</h2>
            
            <div id="video-container" style="display: flex; gap: 20px; margin: 20px 0;">
                <video id="localVideo" autoplay muted playsinline></video>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
            
            <div id="call-controls" style="display: flex; gap: 15px;">
                <button onclick="toggleVideo()" id="toggle-video-btn">üìπ</button>
                <button onclick="toggleAudio()" id="toggle-audio-btn">üé§</button>
                <button onclick="endCall()" id="hangup-btn">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
        </div>

        <div class="sidebar">
            <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω</h3>
            <div id="user-list" class="user-list"></div>
            <button onclick="logout()" style="margin: 10px; width: auto; background: #d9534f;">–í—ã—Ö–æ–¥</button>
        </div>
        <div class="chat-area">
            <div class="chat-header" id="chat-header">–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</div>
            <div class="messages" id="messages"></div>
            
            <div class="input-area">
                <label for="file-upload" style="background:none; border:none; color:white; cursor:pointer; font-size:1.5rem; line-height: 40px;">üìé</label>
                <input type="file" id="file-upload" style="display: none;" onchange="uploadFile(this.files[0])">
                
                <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleEnter(event)">
                <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

                <button id="voice-record-btn" onclick="toggleRecording()">üé§</button>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let currentUser = null;
        let activeChat = null;      
        let chatHistory = {};       
        
        // --- –í–ê–® RADMIN IP-–ê–î–†–ï–° –ò –ü–û–†–¢ –°–ï–†–í–ï–†–ê ---
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Radmin VPN IP, —á—Ç–æ–±—ã –¥—Ä—É–∑—å—è –º–æ–≥–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è (–ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏, —á—Ç–æ –æ–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ —Å–≤–æ–π –±—Ä–∞—É–∑–µ—Ä!)
        const SERVER_IP = '26.84.199.190'; 
        const PORT = 4000;
        // ------------------------------------------

        // --- –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø (MediaRecorder) ---
        let mediaRecorder = null;
        let audioChunks = [];
        let audioStream = null;

        // --- WEBRTC STATE AND CONFIG ---
        let currentPeer = null; 
        let currentCall = null; 
        let localStream = null;
        const STUN_SERVERS = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // --- NAVIGATION & AUTH ---
        function showRegister() { switchScreen('register-screen'); }
        function showLogin() { switchScreen('login-screen'); }
        function switchScreen(id) {
            document.querySelectorAll('.auth-container, .app-container').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function register() {
            const user = document.getElementById('reg-user').value;
            const pass = document.getElementById('reg-pass').value;
            if(!user || !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");

            const res = await fetch(`http://${SERVER_IP}:${PORT}/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: user, password: pass })
            });
            const data = await res.json();
            if(data.success) { alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ."); showLogin(); } 
            else alert(data.message);
        }

        async function login() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            
            const res = await fetch(`http://${SERVER_IP}:${PORT}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: user, password: pass })
            });
            const data = await res.json();
            
            if(data.success) {
                currentUser = user;
                initSocket();
                switchScreen('app-screen');
            } else {
                alert(data.message);
            }
        }

        function logout() {
            location.reload();
        }

        // --- SOCKET, CHAT, MESSAGES ---
        function initSocket() {
            socket = io(`http://${SERVER_IP}:${PORT}`);
            socket.emit('user_connected', currentUser);
            
            // --- –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò –°–û–û–ë–©–ï–ù–ò–ô –ü–†–ò –í–•–û–î–ï ---
            fetch(`http://${SERVER_IP}:${PORT}/messages`) 
                .then(res => res.json())
                .then(allMessages => {
                    allMessages.forEach(msg => {
                        if (msg.from === currentUser || msg.to === currentUser) {
                            const friend = msg.from === currentUser ? msg.to : msg.from;
                            
                            if (!chatHistory[friend]) {
                                chatHistory[friend] = [];
                            }
                            chatHistory[friend].push(msg);
                        }
                    });
                    
                    const friendsWithHistory = Object.keys(chatHistory);
                    if (friendsWithHistory.length > 0) {
                        selectChat(friendsWithHistory[0]);
                    }
                })
                .catch(e => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:", e));
            // ---------------------------------------------


            // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
            socket.on('update_user_list', (users) => {
                const list = document.getElementById('user-list');
                list.innerHTML = users.map(u => {
                    if (u === currentUser) {
                         return `<div class="user-item" style="background: #333; cursor:default;">
                            <div class="online-dot"></div> ${u} (–í—ã)
                        </div>`;
                    }
                    
                    const isActive = u === activeChat;
                    const activeAttr = isActive ? 'data-active="true"' : '';

                    return `
                        <div class="user-item" onclick="selectChat('${u}')" ${activeAttr}>
                            <div class="online-dot"></div> ${u} 
                            <button onclick="startCall('${u}', true); event.stopPropagation();" style="margin-left:auto; background: none; border: none; color: lime;">üìπ</button>
                            <button onclick="startCall('${u}', false); event.stopPropagation();" style="margin-left:5px; background: none; border: none; color: lightblue;">üìû</button>
                        </div>
                    `;
                }).join('');
            });

            // –û–ë–†–ê–ë–û–¢–ß–ò–ö: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            socket.on('receive_message', (msg) => {
                const friend = msg.from === currentUser ? msg.to : msg.from;

                if (!chatHistory[friend]) {
                    chatHistory[friend] = [];
                }
                chatHistory[friend].push(msg);
                
                if (friend === activeChat) {
                    renderMessage(msg);
                }
            });
            
            // --- WEBRTC SIGNALING HANDLERS ---
            
            socket.on('incoming_call', async (data) => {
                const { from, offer, isVideo } = data;
                if (currentCall) {
                    socket.emit('call_ended', { to: from });
                    return;
                }

                if (confirm(`–í—Ö–æ–¥—è—â–∏–π ${isVideo ? '–≤–∏–¥–µ–æ' : '–≥–æ–ª–æ—Å–æ–≤–æ–π'} –∑–≤–æ–Ω–æ–∫ –æ—Ç ${from}. –ü—Ä–∏–Ω—è—Ç—å?`)) {
                    if (!await startLocalStream(isVideo)) return;
                    
                    currentPeer = from;
                    setupWebRTC();
                    document.getElementById('call-status').textContent = `–ó–≤–æ–Ω–æ–∫: ${from}`;
                    document.getElementById('call-modal').style.display = 'flex';
                    
                    await currentCall.setRemoteDescription(new RTCSessionDescription(offer));
                    
                    const answer = await currentCall.createAnswer();
                    await currentCall.setLocalDescription(answer);
                    
                    socket.emit('answer_call', { to: from, answer: answer });
                } else {
                    socket.emit('call_ended', { to: from });
                }
            });

            socket.on('call_accepted', async (data) => {
                await currentCall.setRemoteDescription(new RTCSessionDescription(data.answer));
                document.getElementById('call-status').textContent = `–ó–≤–æ–Ω–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å ${currentPeer}`;
            });

            socket.on('ice_candidate', async (candidate) => {
                if (currentCall && candidate) {
                    try {
                        await currentCall.addIceCandidate(candidate);
                    } catch (e) {
                        console.error('Error adding received ice candidate', e);
                    }
                }
            });

            socket.on('call_ended', () => {
                endCall(true);
                document.getElementById('call-status').textContent = "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫.";
                setTimeout(() => {
                    document.getElementById('call-modal').style.display = 'none';
                }, 2000);
            });
        }
        
        function selectChat(username) {
            if (username === currentUser) return; 
            
            activeChat = username;
            document.getElementById('chat-header').textContent = `–ß–∞—Ç —Å: ${username}`;
            
            socket.emit('user_connected', currentUser); 
            
            if (!chatHistory[username]) {
                chatHistory[username] = [];
            }
            
            const messagesBox = document.getElementById('messages');
            messagesBox.innerHTML = '';
            chatHistory[username].forEach(msg => renderMessage(msg));
            messagesBox.scrollTop = messagesBox.scrollHeight;
        }


        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            
            if (!activeChat) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.");
            if (!text) return;

            const msgData = { 
                from: currentUser, 
                to: activeChat, 
                text: text 
            };
            socket.emit('send_message', msgData);
            input.value = '';
        }
        
        // –§–£–ù–ö–¶–ò–Ø: –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–ê
        async function uploadFile(file) {
            if (!activeChat) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª.");
                document.getElementById('file-upload').value = null; 
                return;
            }
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            
            const placeholderMsg = renderFilePlaceholder(file.name);

            try {
                const response = await fetch(`http://${SERVER_IP}:${PORT}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                placeholderMsg.remove();
                
                if (data.success) {
                    const fileMsgData = { 
                        from: currentUser, 
                        to: activeChat, 
                        url: data.url, 
                        mimeType: data.mimeType,
                        originalName: data.originalName,
                        text: ''
                    };
                    socket.emit('send_message', fileMsgData); 
                    
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞.');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.');
            }
            document.getElementById('file-upload').value = null; 
        }

        // –§–£–ù–ö–¶–ò–Ø: –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø/–§–ê–ô–õ–ê/–ì–û–õ–û–°–ê
        function renderMessage(msg) {
            const box = document.getElementById('messages');
            const isMe = msg.from === currentUser;
            
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;

            let contentHTML = '';
            
            if (msg.isVoice) {
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                const fullUrl = `http://${SERVER_IP}:${PORT}${msg.url}`;
                contentHTML = `
                    <div class="voice-message">
                        <audio controls src="${fullUrl}"></audio>
                        <span>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
                    </div>
                `;
            } else if (msg.url) {
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–∞–π–ª–∞
                const isImage = msg.mimeType && msg.mimeType.startsWith('image/');
                const isVideo = msg.mimeType && msg.mimeType.startsWith('video/');
                
                const fullUrl = `http://${SERVER_IP}:${PORT}${msg.url}`;

                if (isImage) {
                    contentHTML = `<img src="${fullUrl}" alt="${msg.originalName}">`;
                } else if (isVideo) {
                    contentHTML = `<video src="${fullUrl}" controls></video>`;
                } else {
                    contentHTML = `
                        <p>üìÑ ${msg.originalName}</p>
                        <a href="${fullUrl}" target="_blank">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>
                    `;
                }
            } else {
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞/—Å—Ç–∏–∫–µ—Ä–æ–≤/—ç–º–æ–¥–∑–∏
                contentHTML = msg.text.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g, (m) => `<span class="emoji-sticker">${m}</span>`);
            }

            div.innerHTML = `
                <div style="font-size:0.7rem; opacity:0.8; margin-bottom:2px;">${msg.from}</div>
                ${contentHTML}
                <div class="msg-meta">${msg.time}</div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
        
        function renderFilePlaceholder(fileName) {
            const box = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `msg sent`;
            div.innerHTML = `
                <div style="opacity: 0.5;">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞: ${fileName}...</div>
                <div class="msg-meta">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div;
        }

        // --- –§–£–ù–ö–¶–ò–ò –ì–û–õ–û–°–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô ---
        async function toggleRecording() {
            const btn = document.getElementById('voice-record-btn');
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // 1. –û–°–¢–ê–ù–û–í–ö–ê –ó–ê–ü–ò–°–ò
                mediaRecorder.stop();
                btn.classList.remove('recording');
                btn.textContent = 'üé§';
            } else {
                // 2. –ù–ê–ß–ê–õ–û –ó–ê–ü–ò–°–ò
                if (!activeChat) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.");
                
                try {
                    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(audioStream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await uploadVoiceMessage(audioBlob);

                        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                        audioStream.getTracks().forEach(track => track.stop());
                        audioStream = null;
                        mediaRecorder = null;
                    };

                    mediaRecorder.start();
                    btn.classList.add('recording');
                    btn.textContent = 'üî¥';
                } catch (e) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è!');
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', e);
                }
            }
        }

        async function uploadVoiceMessage(audioBlob) {
            const formData = new FormData();
            formData.append('file', audioBlob, `voice-${Date.now()}.webm`); 
            
            try {
                const response = await fetch(`http://${SERVER_IP}:${PORT}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const voiceMsgData = { 
                        from: currentUser, 
                        to: activeChat, 
                        url: data.url, 
                        mimeType: 'audio/webm',
                        originalName: data.originalName,
                        isVoice: true, 
                        text: ''
                    };
                    socket.emit('send_message', voiceMsgData); 
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.');
                }
            } catch (error) {
                console.error('Upload error (voice):', error);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.');
            }
        }
        
        // -----------------------------------------------------------------
        // --- WEBRTC FUNCTIONS ---
        // -----------------------------------------------------------------
        
        async function startLocalStream(isVideo) {
            const videoElement = document.getElementById('localVideo');
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            try {
                const constraints = { audio: true, video: isVideo ? { width: 320, height: 240 } : false };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints); 
                
                videoElement.srcObject = localStream;
                
                document.getElementById('localVideo').style.display = isVideo ? 'block' : 'none';
                document.getElementById('remoteVideo').style.display = isVideo ? 'block' : 'none';
                document.getElementById('toggle-video-btn').disabled = !isVideo;
                
            } catch (e) {
                let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞.';
                
                if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                    errorMessage = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                } else if (e.name === 'NotFoundError') {
                    errorMessage = '–ö–∞–º–µ—Ä–∞ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
                } else if (e.name === 'NotReadableError') {
                    errorMessage = '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–æ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π.';
                }
                
                alert(`–û—à–∏–±–∫–∞ –º–µ–¥–∏–∞: ${errorMessage}`);
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞ (WebRTC):', e);
                
                return null; 
            }
            return localStream;
        }

        function setupWebRTC() {
            currentCall = new RTCPeerConnection(STUN_SERVERS);
            
            localStream.getTracks().forEach(track => currentCall.addTrack(track, localStream));

            currentCall.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            currentCall.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice_candidate', {
                        to: currentPeer,
                        candidate: event.candidate,
                    });
                }
            };
        }

        async function startCall(targetUsername, isVideo) {
            if (currentCall) return alert('–í—ã —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ.');
            
            const stream = await startLocalStream(isVideo);
            if (!stream) return; 
            
            currentPeer = targetUsername;
            setupWebRTC();

            document.getElementById('call-status').textContent = `–ó–≤–æ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUsername}...`;
            document.getElementById('call-modal').style.display = 'flex';

            try {
                const offer = await currentCall.createOffer();
                await currentCall.setLocalDescription(offer);
                
                socket.emit('call_user', {
                    userToCall: targetUsername,
                    from: currentUser,
                    offer: currentCall.localDescription,
                    isVideo: isVideo
                });

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è WebRTC:", e);
                endCall();
                alert("–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞.");
            }
        }

        function endCall(isRemote = false) {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            document.getElementById('call-modal').style.display = 'none';
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            if (!isRemote && currentPeer) {
                socket.emit('call_ended', { to: currentPeer });
            }
            currentPeer = null;
            
            document.getElementById('toggle-video-btn').textContent = 'üìπ';
            document.getElementById('toggle-audio-btn').textContent = 'üé§';
        }

        function toggleVideo() {
            const track = localStream.getVideoTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                document.getElementById('toggle-video-btn').textContent = track.enabled ? 'üìπ' : '‚ùå';
            }
        }
        function toggleAudio() {
            const track = localStream.getAudioTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                document.getElementById('toggle-audio-btn').textContent = track.enabled ? 'üé§' : 'üîá';
            }
        }
        
    </script>
</body>
</html>